{% extends 'layout.html' %}

{% block content %}

<!-- SECTION 1: START SCREEN (If no tournament is active) -->
{% if not tournament_name %}
<div class="row justify-content-center min-vh-50 align-items-center mt-5">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary text-white text-center py-4">
                <h2 class="h3 mb-0 fw-bold">üèÜ New Tournament</h2>
            </div>
            <div class="card-body p-5">
                <p class="text-muted text-center mb-4">Enter a name to initialize the pairing system.</p>
                
                <form action="{{ url_for('main.set_tournament_name') }}" method="post">
                    <div class="form-floating mb-3">
                        <input type="text" name="tournament_name" class="form-control form-control-lg" id="tName" placeholder="Tournament Name" required autofocus>
                        <label for="tName">Tournament Name</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 btn-lg fw-bold shadow-sm">Start Event &rarr;</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- SECTION 2: DASHBOARD (Active Tournament) -->
{% else %}

<!-- Dashboard Header -->
<div class="bg-dark text-white rounded-3 p-4 mb-4 shadow-sm d-flex justify-content-between align-items-center">
    <div>
        <h6 class="text-uppercase text-secondary mb-1 ls-1">Active Event</h6>
        <h1 class="h2 fw-bold mb-0 text-white">{{ tournament_name }}</h1>
    </div>
    <a href="{{ url_for('main.reset_and_home') }}" onclick="return confirm('Are you sure? This will delete all current progress.')" class="btn btn-outline-danger btn-sm">
        &times; Quit / Reset
    </a>
</div>

<div class="row g-4">
    <!-- LEFT COLUMN: Quick Actions -->
    <div class="col-lg-4">
        
        <!-- 1. Quick Add Player Card -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                <h5 class="fw-bold text-primary mb-0">Add Player</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('main.index') }}" method="post">
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="small text-muted fw-bold">Player Name</label>
                            <input type="text" name="name" class="form-control" placeholder="e.g. Magnus Carlsen" required>
                        </div>
                        <div class="col-7">
                            <label class="small text-muted fw-bold">Rating</label>
                            <input type="number" name="rating" class="form-control" placeholder="1200" required>
                        </div>
                        <div class="col-5 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100 fw-bold">
                                + Add
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 2. Status Card -->
        <div class="card shadow-sm border-0 bg-light">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small fw-bold">Current Status</h6>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <span class="display-6 fw-bold text-dark">{{ current_round }}</span>
                        <span class="text-muted small">Rounds Played</span>
                    </div>
                    <div>
                        <span class="display-6 fw-bold text-dark">{{ players|length }}</span>
                        <span class="text-muted small">Players</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN: Standings & Controls -->
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">Standings</h5>
                
                <!-- Pairing Button -->
                <form action="{{ url_for('main.generate_pairings') }}" method="post">
                    <button type="submit" class="btn btn-success fw-bold shadow-sm">
                        {% if current_round == 0 %}
                            üöÄ Start Round 1
                        {% else %}
                            ‚ö° Generate Round {{ current_round + 1 }}
                        {% endif %}
                    </button>
                </form>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary small text-uppercase">
                        <tr>
                            <th class="ps-4">Rank</th>
                            <th>Name</th>
                            <th>Rating</th>
                            <th class="fw-bold text-dark">Points</th>
                            <th>Buchholz</th>
                        </tr>
                    </thead>
                    <tbody class="border-top-0">
                        {% for p in players %}
                        <tr>
                            <td class="ps-4 text-muted fw-bold">#{{ loop.index }}</td>
                            <td class="fw-semibold text-dark">{{ p.name }}</td>
                            <td class="text-muted">{{ p.rating }}</td>
                            <td><span class="badge bg-primary fs-6">{{ p.points }}</span></td>
                            <td class="text-muted small">{{ p.buchholz }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <div class="py-4">
                                    <h1 class="display-4">üë•</h1>
                                    <p class="mb-0">No players registered yet.</p>
                                    <p class="small">Use the form on the left to add participants.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Footer: End Tournament -->
            {% if current_round > 0 %}
            <div class="card-footer bg-white border-top-0 py-3">
                <div class="d-flex justify-content-end">
                    <form action="{{ url_for('main.end_tournament') }}" method="post">
                        <button type="submit" class="btn btn-warning text-dark fw-bold" onclick="return confirm('Archive this tournament to history?')">
                            üèÅ Conclude Tournament
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}